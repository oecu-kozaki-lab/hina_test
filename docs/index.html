<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼¢å­—åˆ†é¡è¬è§£ã</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to bottom right, #e8f5e9, #e3f2fd);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #c62828;
        }

        .groups-display {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .group-box {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .group-header {
            padding: 15px;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
        }

        .group-header.green {
            background: #4CAF50;
        }

        .group-header.blue {
            background: #2196F3;
        }

        .group-content {
            padding: 20px;
            min-height: 180px;
        }

        .kanji-item {
            padding: 12px 15px;
            margin-bottom: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            text-align: center;
        }

        .kanji-item-left {
            font-size: 1.5em;
            font-weight: bold;
        }

        .question-box {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .question-text {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 20px;
        }

        .question-kanji {
            font-size: 4em;
            font-weight: bold;
            color: #FF5722;
            margin: 30px 0;
        }

        .answer-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }

        .answer-btn {
            padding: 20px 60px;
            font-size: 1.5em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .answer-btn.green {
            background: #4CAF50;
            color: white;
        }

        .answer-btn.blue {
            background: #2196F3;
            color: white;
        }

        .answer-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .result-box {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .result-box.correct {
            border: 4px solid #4CAF50;
        }

        .result-box.incorrect {
            border: 4px solid #f44336;
        }

        .result-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }

        .result-text {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .result-text.correct {
            color: #4CAF50;
        }

        .result-text.incorrect {
            color: #f44336;
        }

        .explanation {
            font-size: 1.1em;
            color: #555;
            margin: 20px 0;
            padding: 25px;
            background: #f5f5f5;
            border-radius: 8px;
            text-align: left;
            line-height: 1.8;
        }

        .explanation ul {
            margin: 15px 0;
            padding-left: 25px;
        }

        .explanation li {
            margin: 8px 0;
        }

        .explanation strong {
            color: #2196F3;
        }

        .explanation .highlight {
            color: #FF5722;
            font-weight: bold;
        }

        .next-btn {
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            background: #FF9800;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .next-btn:hover {
            background: #F57C00;
            transform: translateY(-2px);
        }

        .hidden {
            display: none !important;
        }

        .feedback-section {
            margin: 30px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 2px dashed #ccc;
        }

        .feedback-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #555;
            margin-bottom: 15px;
            text-align: center;
        }

        .feedback-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .feedback-btn {
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border: 2px solid;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .feedback-btn.enlightenment {
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .feedback-btn.enlightenment:hover {
            background: #4CAF50;
            color: white;
        }

        .feedback-btn.enlightenment.selected {
            background: #4CAF50;
            color: white;
        }

        .feedback-btn.knowledge {
            border-color: #FF9800;
            color: #FF9800;
        }

        .feedback-btn.knowledge:hover {
            background: #FF9800;
            color: white;
        }

        .feedback-btn.knowledge.selected {
            background: #FF9800;
            color: white;
        }

        .correction-input {
            margin-top: 15px;
        }

        .correction-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 0.95em;
        }

        .correction-input textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .correction-input textarea:focus {
            outline: none;
            border-color: #2196F3;
        }

        .stats-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: #673AB7;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            z-index: 1000;
        }

        .stats-button:hover {
            background: #5E35B1;
            transform: translateY(-2px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 900px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h2 {
            margin: 0;
            color: #333;
        }

        .close-btn {
            font-size: 2em;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #333;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
        }

        .stat-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
        }

        .stat-card.orange {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .section-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin: 30px 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .download-btn {
            padding: 12px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }

        .download-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .ab-test-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .ab-test-table th,
        .ab-test-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .ab-test-table th {
            background: #f5f5f5;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .groups-display {
                grid-template-columns: 1fr;
            }

            .answer-buttons {
                flex-direction: column;
            }

            .question-kanji {
                font-size: 3em;
            }

            .stats-button {
                top: 10px;
                right: 10px;
                padding: 10px 20px;
                font-size: 0.9em;
            }

            .feedback-buttons {
                flex-direction: column;
            }
        }

        /* æ–°ç”»é¢ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .screen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }

        .screen-content {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 600px;
            width: 90%;
        }

        .screen-title {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .start-btn {
            display: block;
            width: 100%;
            padding: 20px;
            margin: 15px 0;
            font-size: 1.3em;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .start-btn.primary {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }

        .start-btn.secondary {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            margin-top: 20px;
        }

        .start-btn.tertiary {
            background: #9E9E9E;
            font-size: 1em;
            padding: 15px;
            margin-top: 30px;
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .progress-container {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-weight: bold;
            color: #555;
            z-index: 100;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .fade-out {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
    <div id="startScreen" class="screen-overlay hidden">
        <div class="screen-content">
            <h1 class="screen-title">æ¼¢å­—åˆ†é¡è¬è§£ã</h1>
            <p style="margin-bottom: 30px; font-size: 1.2em; color: #666; line-height: 1.6;">
                æ¼¢å­—ã®å…±é€šç‚¹ã‚’è¦‹ã¤ã‘ã‚‹è¬è§£ãã§ã™ã€‚<br>
                1ã‚»ãƒƒãƒˆ10å•ã€‚<br>
                å…¨å•æ­£è§£ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼
            </p>

            <div style="margin-bottom: 20px;">
                <label for="datasetSelect"
                    style="display: block; margin-bottom: 10px; font-weight: bold; color: #555;">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’é¸æŠï¼š</label>
                <select id="datasetSelect"
                    style="padding: 10px; width: 100%; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1em;">
                    <option value="1000">é–²è¦§æ•°1000ä»¥ä¸Š</option>
                    <option value="1500">é–²è¦§æ•°1500ä»¥ä¸Š</option>
                    <option value="2000">é–²è¦§æ•°2000ä»¥ä¸Š</option>
                    <option value="2500">é–²è¦§æ•°2500ä»¥ä¸Š</option>
                    <option value="3000">é–²è¦§æ•°3000ä»¥ä¸Š</option>
                </select>
            </div>
            <button class="start-btn primary" onclick="startGame(true)">
                <div>ãµã‚ŠãŒãª <span style="font-size: 1.5em; margin: 0 5px;">ã‚ã‚Š</span> ã§éŠã¶</div>
                <div style="font-size: 0.7em; font-weight: normal; opacity: 0.9;">ï¼ˆèª­ã¿ã‚„ã™ã•é‡è¦–ï¼‰</div>
            </button>
            <button class="start-btn secondary" onclick="startGame(false)">
                <div>ãµã‚ŠãŒãª <span style="font-size: 1.5em; margin: 0 5px;">ãªã—</span> ã§éŠã¶</div>
                <div style="font-size: 0.7em; font-weight: normal; opacity: 0.9;">ï¼ˆé›£æ˜“åº¦ã‚¢ãƒƒãƒ—ï¼‰</div>
            </button>
            <button class="start-btn tertiary" onclick="showStats()">
                ğŸ“Š ã“ã‚Œã¾ã§ã®æˆç¸¾ã‚’è¦‹ã‚‹
            </button>
        </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ çµ‚äº†ç”»é¢ -->
    <div id="gameEndScreen" class="screen-overlay hidden">
        <div class="screen-content">
            <h1 class="screen-title">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</h1>
            <div style="margin: 30px 0;">
                <p style="color: #666; font-size: 1.2em;">ä»Šå›ã®æ­£è§£ç‡</p>
                <div id="finalScore"
                    style="font-size: 5em; color: #4CAF50; font-weight: bold; text-shadow: 2px 2px 0px rgba(0,0,0,0.1);">
                    8/10</div>
                <p id="finalScoreText" style="font-size: 1.5em; color: #333; font-weight: bold;">ç´ æ™´ã‚‰ã—ã„ï¼</p>
            </div>
            <button class="start-btn primary" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ é€²è¡ŒçŠ¶æ³ -->
    <div id="progressContainer" class="progress-container hidden">
        ç¬¬ <span id="currentQuestionNum">1</span> / 10 å•
    </div>
    <div class="container">
        <h1>æ¼¢å­—åˆ†é¡è¬è§£ã</h1>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
        </div>

        <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
        <div id="error" class="error hidden"></div>

        <!-- ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤º -->
        <div id="groupsDisplay" class="groups-display hidden">
            <div class="group-box">
                <div class="group-header green">ã‚°ãƒ«ãƒ¼ãƒ—A</div>
                <div class="group-content" id="groupADisplay"></div>
            </div>
            <div class="group-box">
                <div class="group-header blue">ã‚°ãƒ«ãƒ¼ãƒ—B</div>
                <div class="group-content" id="groupBDisplay"></div>
            </div>
        </div>

        <!-- å•é¡Œè¡¨ç¤º -->
        <div id="questionBox" class="question-box hidden">
            <div class="question-text">ã‚°ãƒ«ãƒ¼ãƒ—Aã¨ã‚°ãƒ«ãƒ¼ãƒ—Bã®æ¼¢å­—ã‚’ã‚ˆãè¦‹æ¯”ã¹ã¦ã€ãã‚Œãã‚Œã®å…±é€šç‚¹ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚<br>ãã®ä¸Šã§ã€ä¸‹ã®æ¼¢å­—ã¯ã©ã¡ã‚‰ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«å…¥ã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ</div>
            <div class="question-kanji" id="questionKanji"></div>
            <div class="answer-buttons">
                <button class="answer-btn green" onclick="checkAnswer('A')">ã‚°ãƒ«ãƒ¼ãƒ—A</button>
                <button class="answer-btn blue" onclick="checkAnswer('B')">ã‚°ãƒ«ãƒ¼ãƒ—B</button>
            </div>
        </div>

        <!-- çµæœè¡¨ç¤º -->
        <div id="resultBox" class="result-box hidden">
            <div class="result-icon" id="resultIcon"></div>
            <div class="result-text" id="resultText"></div>
            <div class="explanation" id="explanation"></div>

            <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="feedback-section">
                <div class="feedback-title">ã“ã®å•é¡Œã¯ã©ã†ã§ã—ãŸã‹ï¼Ÿ</div>
                <div class="feedback-buttons">
                    <button class="feedback-btn enlightenment" onclick="submitFeedback('enlightenment')">ğŸ’¡
                        ã‚¹ãƒƒã‚­ãƒªã—ãŸï¼ˆé–ƒã„ãŸï¼ï¼‰</button>
                    <button class="feedback-btn knowledge" onclick="submitFeedback('knowledge')">ğŸ“š
                        ã‚¹ãƒƒã‚­ãƒªã—ãªã‹ã£ãŸï¼ˆçŸ¥è­˜å•é¡Œï¼‰</button>
                </div>
                <div class="correction-input">
                    <label for="correctionText">ä¿®æ­£ç‚¹(å•é¡Œã«ãŠã‹ã—ãªç‚¹ãŒã‚ã‚Œã°è¨˜å…¥ã—ã¦ãã ã•ã„):</label>
                    <textarea id="correctionText" placeholder="ä¾‹: èª­ã¿æ–¹ãŒé‡è¤‡ã—ã¦ã„ã‚‹ã€åˆ†é¡ãŒä¸é©åˆ‡ãªã©"></textarea>
                </div>
            </div>

            <button class="next-btn" onclick="nextQuestion()">æ¬¡ã®å•é¡Œã¸</button>
        </div>

        <!-- è©•ä¾¡çµ±è¨ˆãƒœã‚¿ãƒ³ -->
        <button class="stats-button" onclick="showStats()" id="statsButton">ğŸ“Š è©•ä¾¡ãƒ¬ãƒãƒ¼ãƒˆ</button>

        <!-- è©•ä¾¡ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="statsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ“Š è©•ä¾¡ãƒ¬ãƒãƒ¼ãƒˆ</h2>
                    <span class="close-btn" onclick="closeStats()">&times;</span>
                </div>

                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalQuestions">0</div>
                        <div class="stat-label">ç·å•é¡Œæ•°</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-value" id="correctRate">0%</div>
                        <div class="stat-label">æ­£è§£ç‡</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-value" id="avgTime">0.0s</div>
                        <div class="stat-label">å¹³å‡è§£ç­”æ™‚é–“</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-value" id="enlightenmentRate">0%</div>
                        <div class="stat-label">è¬è§£ãæˆåŠŸåº¦ï¼ˆé–ƒãç‡ï¼‰</div>
                    </div>
                </div>

                <div class="section-title">UXè©•ä¾¡</div>
                <div id="uxAnalysis"></div>

                <div class="section-title">A/Bãƒ†ã‚¹ãƒˆçµæœ</div>
                <div id="abTestResults"></div>

                <div class="section-title">é¡ä¼¼æ€§ã‚¹ã‚³ã‚¢åˆ†æ</div>
                <div id="similarityAnalysis"></div>

                <div class="section-title">ã‚·ã‚¹ãƒ†ãƒ åŠ¹ç‡æ€§</div>
                <div id="efficiencyAnalysis"></div>

                <button class="download-btn" onclick="downloadCSV()">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let currentCriteria = null;
        let groupAData = [];
        let groupBData = [];
        let currentQuestion = null;
        let displayedGroupA = [];
        let displayedGroupB = [];

        const MAX_QUESTIONS = 10;
        let questionCount = 0;
        let sessionCorrectCount = 0;

        // è©•ä¾¡æ©Ÿèƒ½ç”¨ã®å¤‰æ•°
        let questionStartTime = null;
        let currentSessionData = null;
        let userGroup = null;  // 'A' or 'B' for A/B testing
        let showFurigana = false;
        let currentCorrection = '';  // ä¿®æ­£ç‚¹ã‚’ä¿å­˜

        const keywords = {
            nature: ['ã„ã‘','ã—ã¾','ã„ãšã¿', 'ã‹ãœ', 'ã‹ã‚', 'ãã‚‚', 'ãŸã«', 'ã¿ãšã†ã¿', 'ã‚„ã¾', 'ã‚†ã', 'ã†ã¿', 'ã†ã¿ã‚„ã¾', 'ã†ã‚“ãŒ', 'ãˆã‚“ã“', 'ãˆã‚“ã§ã‚“', 'ãŠãŒã‚', 'ãŠã‚“ã›ã‚“', 'ã‹ã„ã–ã‚“', 'ã‹ã„ã‚Šã‚…ã†', 'ã‹ã“ã†', 'ã‹ã˜ã‚…', 'ã‹ã–ã‚“', 'ã‹ã‚Šã‚…ã†', 'ãŒã‚“ã¿ã‚ƒã', 'ãã†ã‚“', 'ãã‚‡ã†ã‚Šã‚…ã†', 'ã‘ã‚“ã†ã‚“', 'ã“ã†ã™ã„', 'ã”ã†ã‚Šã‚…ã†', 'ã•ã‚“ã¡', 'ã•ã‚“ã¿ã‚ƒã', 'ã—ãŠ', 'ã—ã‚Šã‚…ã†', 'ã™ã„ã’ã‚“', 'ãã†ã†ã‚“', 'ãã†ã†ã‚“', 'ãŸã„ãµã†', 'ãŸã„ã‚Šã', 'ã ã‚“ãã†', 'ã¦ã‚“ã', 'ã­ã£ã±', 'ã®ã‚ã', 'ã¯ã‚„ã›', 'ã¯ã‚“ã¨ã†', 'ã²ãŒãŸ', 'ãµã†', 'ã¾ãã†ã‚“', 'ã¿ãšã†ã¿', 'ã‚„ã¾', 'ã‚†ã', 'ã‚Šã‚‡ã†ã‹ã„', 'ã‚Šã‚…ã†ã‚', 'ã‚Œã„ã“', 'ã‚ã‚“'],
            color: ['ã‚ãŠ', 'ã‚ã‹', 'ãã„ã‚', 'ãã‚“', 'ãã‚“ã—ã', 'ãã•', 'ãã‚', 'ã•ãã‚‰', 'ã—ã‚', 'ãŸã„', 'ãŸã‚“', 'ã¡ã‚ƒ', 'ã©ã†', 'ã¨ã', 'ã­ã‚Š', 'ã¯ãª', 'ã¯ã„', 'ã¹ã«', 'ã¿ãšã„ã‚', 'ã¿ã©ã‚Š', 'ã‚€ã—ã‚‡ã', 'ã‚‚ã‚‚', 'ã‚†ã', 'ã‚‰ã‚“', 'ã‚Šã‚‡ãã—ã‚‡ã', 'ã‚ã‹ãã•', 'ã‚ãŠã’', 'ã‚ãŠã¿ã©ã‚Š', 'ã‚ã‹ã’', 'ã‚ã‹ãŒã¿', 'ã†ã¯ã„', 'ã‹ã£ã—ã‚‡ã', 'ãã„ã‚', 'ãã¿ã©ã‚Š', 'ãã‚“ã„ã‚', 'ãã‚“ã—ã', 'ãã•ã„ã‚', 'ãã‚Œãªã„', 'ãã‚ã¯ã', 'ã“ã†ã¯ã', 'ã•ãã‚‰ã„ã‚', 'ã—ã‚ã’', 'ã—ã‚ãã‚', 'ã—ã‚“ã', 'ãã‚‰ã„ã‚', 'ã¡ã‚ƒã„ã‚', 'ã©ã†ã—ã‚‡ã', 'ã¨ãã—ã‚‡ã', 'ãªãªã„ã‚', 'ã­ã‚Šã„ã‚', 'ã¯ã”ã‚ã‚‚', 'ã¯ã„ã„ã‚', 'ãµã‚†ã’', 'ã¹ã«ã„ã‚', 'ã¹ã«ã—ã‚', 'ã»ã—ã‚‡ã', 'ã¿ã©ã‚Š', 'ã¿ã©ã‚Šã‚', 'ã¿ãšã„ã‚', 'ã‚€ã—ã‚‡ã', 'ã‚‚ã¿ã˜', 'ã‚‰ã‚“ã—ã‚‡ã', 'ã‚Šã‚‡ãã—ã‚‡ã', 'ã‚Œã‚“ã—ã‚‡ã'],
            animal: ['ã‚ã¶', 'ã„ã¬', 'ã„ãˆã„ã¬', 'ã†ã—', 'ãˆã³', 'ã‹ã', 'ã‹ã«', 'ã‹ã‚‚', 'ãã˜', 'ãã¾', 'ãã‚‚', 'ã•ã°', 'ã•ã‚‹', 'ã—ã‹', 'ãã†', 'ãŸã“', 'ã ã«', 'ã¤ã¶', 'ã¤ã‚‹', 'ã­ã“', 'ã„ãˆã­ã“', 'ã¯ãˆ', 'ã¯ã¡', 'ãµã', 'ã¸ã³', 'ã‚„ã”', 'ã‚ã°', 'ã“ã†ã—', 'ã«ã—ãã”ã„', 'ãŠã†ã—', 'ã‚ã†ã—', 'ã•ã‹ãª', 'ã“ã„', 'ãŸã„', 'ã¨ã‚Š', 'ã“ã¨ã‚Š', 'ã¯ã¨', 'ã‹ã‚‚ã‚', 'ã‚ã—', 'ãŸã‹','ã‚ã«','ã•ã', 'ã­ãšã¿'],
            body: ['ã‚ã—', 'ã‚ãŸã¾', 'ãˆã ', 'ã‹ãŠ', 'ãã¡', 'ãã³', 'ã—ãŸ', 'ã¯ãª', 'ã¯ã—', 'ã¯ã‚Š', 'ã²ãŸã„', 'ã»ã­', 'ã‚ã¶ã', 'ã‚‚ã†', 'ã‚„ã„ã°', 'ã‚†ã³', 'ã‚ˆã†', 'ã‚ã—ãã³', 'ã‚ã—ã¼ã­', 'ã„ã—', 'ã„ãŸã„', 'ã„ã¦ã‚“', 'ã†ã‚‚ã†', 'ã†ã‚ã‚ã”', 'ãˆãã‹', 'ãŠã†ãŸã„', 'ãŠã‚„ã‚†ã³', 'ã‹ã„ã¡ã‚‡ã†', 'ã‹ãˆã‚“', 'ã‹ã‹ã‚“', 'ã‹ã˜ã‚‡ã†', 'ã‹ãã†', 'ã‹ã¸ã‚“', 'ã‹ã‚“ã›ã¤', 'ã‹ã‚“ã®ã†', 'ãã‹ã‚“', 'ãã‚…ã†ã“ã‚“', 'ãã‚…ã†ã“ã‚“', 'ãã‚…ã†ã—ã¤', 'ãã‚‡ã†ã‹ã', 'ãã‚‡ã†ã“ã¤', 'ãã‚‡ã†ã¶', 'ãã‚“ã«ã', 'ãã†ã¡ã‚‡ã†', 'ã‘ã£ã‹ã‚“', 'ã‘ã£ãã‚…ã†', 'ã‘ã‚“ã—', 'ã“ã†ã‚‚ã‚“', 'ã“ã†ã‚‚ã‚“', 'ã“ã¤', 'ã“ã‚†ã³', 'ã”ã‚Œã‚“', 'ã•ã„ã¼ã†', 'ã•ã‚“ãã‚…ã†', 'ã—ã‹ã‚“', 'ã—ãã‚…ã†', 'ã—ã“ã¤', 'ã—ã˜ã‚‡ã†', 'ã—ãã‚“', 'ã—ã£ã“ã†', 'ã—ã‚ƒã“ã¤', 'ã—ã‚…ã—', 'ã—ã‚‡ã†ãã‚…ã†', 'ã—ã‚‡ã†ã‘ã£ãã‚…ã†', 'ã—ã‚‡ã†ã—', 'ã—ã‚‡ã†ã®ã†', 'ã—ã‚‡ãã©ã†', 'ã—ã‚“ã‘ã„', 'ã—ã‚“ãã†', 'ã˜ã‹ã‚“', 'ã˜ãã‚“', 'ã˜ã²', 'ã˜ã‚“ãã†', 'ã™ã„ã‹ã‚“', 'ã›ã„ã‹ã‚“', 'ã›ã„ã','ã›ã„ãã†', 'ã›ããšã„', 'ã›ãªã‹', 'ã›ã‚“ã—', 'ãã—ã', 'ãŸã„ãŒã‚“', 'ãŸã„ã¡ã‚‡ã†', 'ãŸã‚“ãã‚…ã†', 'ã¡ã¡ãã³', 'ã¡ã‚…ã†ã—', 'ã¡ã‚‡ãã¡ã‚‡ã†', 'ã¦ã„ã®ã†', 'ã¦ãã³', 'ã©ã†ã“ã†ãã†', 'ã©ã†ã¿ã‚ƒã', 'ã©ãã‚‡ã†', 'ãªã„ã²', 'ãªã„ã˜', 'ãªã‹ã‚†ã³', 'ã«ã‚…ã†ã—', 'ã«ã‚…ã†ã¨ã†', 'ã«ã‚…ã†ã‚Šã‚“', 'ã®ã†ã‹ã‚“', 'ã¯ã„ãµ', 'ã¯ã„ã‚‚ã†', 'ã¯ãã—ã¤', 'ã¯ãª', 'ã¯ãªã“ã¤', 'ã²ãµ', 'ã²ã‚‡ã†ã²', 'ãµããŒã‚“', 'ãµãã¶', 'ãµãã‚ˆã†', 'ã¶ã‚“ã‹ã¤', 'ã¸ã', 'ã¾ã‚†', 'ã¿ã', 'ã‚‚ã†ã²', 'ã‚„ãã—', 'ã‚†ã³', 'ã‚ˆã†ã¨ã†', 'ã‚‰ã‚“ãã†', 'ã‚Šã‚…ã†ã‹ã‚“', 'ã‚‹ã„ã—ã‚‡ã†', 'ã‚ã£ã“ã¤']
        };

        const criteriaNames = {
            nature: 'è‡ªç„¶è¦ç´ ',
            color: 'è‰²',
            animal: 'å‹•ç‰©',
            body: 'ä½“ã®éƒ¨ä½'
        };

        // ====== è©•ä¾¡æ©Ÿèƒ½ï¼šãƒ‡ãƒ¼ã‚¿ç®¡ç† ======
        function initEvaluationSystem() {
            // A/Bãƒ†ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã®å‰²ã‚Šå½“ã¦ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®šã®ã¿ã€ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã§ä¸Šæ›¸ãï¼‰
            if (!localStorage.getItem('userGroup')) {
                userGroup = 'B'; // default
                localStorage.setItem('userGroup', userGroup);
            } else {
                userGroup = localStorage.getItem('userGroup');
            }
            showFurigana = (userGroup === 'A');

            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
            if (!localStorage.getItem('evaluationData')) {
                const initialData = {
                    userGroup: userGroup,
                    showFurigana: showFurigana,
                    sessions: []
                };
                localStorage.setItem('evaluationData', JSON.stringify(initialData));
            }
        }

        function startGame(withFurigana) {
            showFurigana = withFurigana;
            userGroup = showFurigana ? 'A' : 'B';
            localStorage.setItem('userGroup', userGroup);

            questionCount = 0;
            sessionCorrectCount = 0;

            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameEndScreen').classList.add('hidden');
            document.querySelector('.container').classList.remove('hidden');
            document.getElementById('progressContainer').classList.remove('hidden');

            generateQuestion();
        }

        function endGame() {
            document.querySelector('.container').classList.add('hidden');
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('gameEndScreen').classList.remove('hidden');

            document.getElementById('finalScore').textContent = `${sessionCorrectCount}/${MAX_QUESTIONS}`;
            const rate = Math.round((sessionCorrectCount / MAX_QUESTIONS) * 100);
            document.getElementById('finalScoreText').textContent = `æ­£è§£ç‡ ${rate}%`;
        }

        function saveSessionData() {
            const evalData = JSON.parse(localStorage.getItem('evaluationData') || '{"sessions":[]}');
            evalData.sessions.push(currentSessionData);
            localStorage.setItem('evaluationData', JSON.stringify(evalData));
        }

        function calculateSimilarityScore(groupA, groupB) {
            let score = 0;

            // èª­ã¿æ–¹ã®é¡ä¼¼æ€§ã‚’è¨ˆç®—
            groupA.forEach(itemA => {
                groupB.forEach(itemB => {
                    const reading1 = itemA.reading;
                    const reading2 = itemB.reading;

                    // æœ€é•·å…±é€šéƒ¨åˆ†æ–‡å­—åˆ—ã®é•·ã•ã‚’è¨ˆç®—
                    const commonLength = getLongestCommonSubstring(reading1, reading2);
                    if (commonLength >= 2) {
                        score += commonLength;
                    }
                });
            });

            return score;
        }

        function getLongestCommonSubstring(str1, str2) {
            let maxLength = 0;
            const m = str1.length;
            const n = str2.length;
            const dp = Array(m + 1).fill(0).map(() => Array(n + 1).fill(0));

            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    if (str1[i - 1] === str2[j - 1]) {
                        dp[i][j] = dp[i - 1][j - 1] + 1;
                        maxLength = Math.max(maxLength, dp[i][j]);
                    }
                }
            }

            return maxLength;
        }


        async function loadFile(filename) {
            try {
                const response = await fetch(filename);
                if (!response.ok) {
                    throw new Error(`${filename} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (Status: ${response.status})`);
                }
                const text = await response.text();
                return text;
            } catch (error) {
                throw error;
            }
        }

        async function loadData(filename) {
            try {
                // Reset data
                allData = [];

                const content = await loadFile(filename);
                // Header might be different or have encoding issues, simpler to skip the first line always if we know it's a header
                // But the current logic checks !line.startsWith('æ¼¢å­—')
                const lines = content.split('\n').filter(line => line.trim() != ''); // Filter empty lines first

                // Skip header if it looks like one (links, kanji, etc or just æ¼¢å­—...)
                // Just skipping the first line might be safer if we are sure there is a header
                const dataLines = lines.slice(1);

                dataLines.forEach(line => {
                    const parts = line.split(',');
                    // Handle potential empty lines or malformed lines
                    if (parts.length < 2) return;

                    if (parts.length >= 3) {
                        const [link, kanji, reading] = parts;
                        if (kanji && reading) {
                            allData.push({ link: link.trim(), kanji: kanji.trim(), reading: reading.trim() });
                        }
                    } else if (parts.length === 2) {
                        const [kanji, reading] = parts;
                        if (kanji && reading) {
                            allData.push({ link: '', kanji: kanji.trim(), reading: reading.trim() });
                        }
                    }
                });

                if (allData.length === 0) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                }

                // Initialize game after data load
                initGame();

            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('startScreen').classList.remove('hidden'); // Show start screen again on error
                const errorDiv = document.getElementById('error');
                errorDiv.classList.remove('hidden');
                errorDiv.innerHTML = `
                    <h3>âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
                    <p>${error.message}</p>
                    <p style="margin-top: 10px;">
                        <strong>è§£æ±ºæ–¹æ³•:</strong><br>
                        1. ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ« (.csv) ãŒHTMLãƒ•ã‚¡ã‚¤ãƒ«ã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„<br>
                        2. ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
                    </p>
                `;
            }
        }

        function classifyData() {
            groupAData = [];
            groupBData = [];

            // Ensure we have data
            if (!allData || allData.length === 0) return;

            const currentKeywords = keywords[currentCriteria];

            allData.forEach(item => {
                // Check if reading exists to prevent errors
                if (!item.reading) return;

                const hasKeyword = currentKeywords.some(kw => item.reading.includes(kw));
                if (hasKeyword) {
                    groupAData.push(item);
                } else {
                    groupBData.push(item);
                }
            });
        }

        function getRandomItems(array, count) {
            if (!array) return [];
            const selected = [];
            const usedReadings = new Set();
            const shuffled = [...array].sort(() => Math.random() - 0.5);

            for (const item of shuffled) {
                if (selected.length >= count) break;
                // èª­ã¿æ–¹ãŒé‡è¤‡ã—ã¦ã„ãªã„å ´åˆã®ã¿è¿½åŠ 
                if (!usedReadings.has(item.reading)) {
                    selected.push(item);
                    usedReadings.add(item.reading);
                }
            }

            return selected;
        }

        function generateQuestion() {
            questionCount++;
            document.getElementById('currentQuestionNum').textContent = questionCount;

            const genStartTime = performance.now();

            // ãƒ©ãƒ³ãƒ€ãƒ ã«åˆ†é¡åŸºæº–ã‚’é¸æŠ
            const criteriaKeys = ['nature', 'color', 'animal', 'body'];
            currentCriteria = criteriaKeys[Math.floor(Math.random() * criteriaKeys.length)];

            // ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é¡
            classifyData();

            // If data is insufficient for this criteria, try another one or handle error
            // Simple check: need at least 1 for question and 4 for display in A, 4 in B
            if (groupAData.length < 5 || groupBData.length < 5) {
                // Retry with different criteria or just proceed (might fail if very low data)
                console.warn('Not enough data for criteria: ' + currentCriteria);
                // Ideally we should retry, but for now let's hope data is sufficient
            }

            // ã¾ãšå•é¡Œç”¨ã®æ¼¢å­—ã‚’Aã¾ãŸã¯Bã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
            const useGroupA = Math.random() < 0.5;

            if (useGroupA) {
                if (groupAData.length === 0) {
                    // Fallback logic could be added here
                }
                currentQuestion = groupAData[Math.floor(Math.random() * groupAData.length)];
                currentQuestion.correctGroup = 'A';

                // ã‚°ãƒ«ãƒ¼ãƒ—Aã‹ã‚‰å•é¡Œã‚’é™¤ã4ã¤ã‚’é¸æŠ
                displayedGroupA = getRandomItems(
                    groupAData.filter(item => item.kanji !== currentQuestion.kanji),
                    4
                );
                // ã‚°ãƒ«ãƒ¼ãƒ—Bã‹ã‚‰4ã¤é¸æŠ
                displayedGroupB = getRandomItems(groupBData, 4);
            } else {
                if (groupBData.length === 0) {
                    // Fallback logic
                }
                currentQuestion = groupBData[Math.floor(Math.random() * groupBData.length)];
                currentQuestion.correctGroup = 'B';

                // ã‚°ãƒ«ãƒ¼ãƒ—Aã‹ã‚‰4ã¤é¸æŠ
                displayedGroupA = getRandomItems(groupAData, 4);
                // ã‚°ãƒ«ãƒ¼ãƒ—Bã‹ã‚‰å•é¡Œã‚’é™¤ã4ã¤ã‚’é¸æŠ
                displayedGroupB = getRandomItems(
                    groupBData.filter(item => item.kanji !== currentQuestion.kanji),
                    4
                );
            }

            const genEndTime = performance.now();
            const generationTime = genEndTime - genStartTime;

            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
            currentSessionData = {
                sessionId: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                timestamp: Date.now(),
                criteria: currentCriteria,
                questionKanji: currentQuestion.kanji,
                questionReading: currentQuestion.reading,
                displayedGroupA: displayedGroupA.map(item => ({ kanji: item.kanji, reading: item.reading })),
                displayedGroupB: displayedGroupB.map(item => ({ kanji: item.kanji, reading: item.reading })),
                correctGroup: currentQuestion.correctGroup,
                selectedGroup: null,
                isCorrect: null,
                startTime: null,
                answerTime: null,
                responseTimeMs: null,
                feedbackType: null,
                correction: '',
                similarityScore: calculateSimilarityScore(displayedGroupA, displayedGroupB),
                generationTimeMs: generationTime
            };

            displayGroups();
            displayQuestion();
        }

        function displayGroups() {
            const groupADiv = document.getElementById('groupADisplay');
            const groupBDiv = document.getElementById('groupBDisplay');

            // A/Bãƒ†ã‚¹ãƒˆï¼šãµã‚ŠãŒãªè¡¨ç¤ºã®æœ‰ç„¡
            if (showFurigana) {
                groupADiv.innerHTML = displayedGroupA.map(item =>
                    `<div class="kanji-item">
                        <ruby>
                            <rb>${item.kanji}</rb>
                            <rt style="font-size: 0.6em;">${item.reading}</rt>
                        </ruby>
                    </div>`
                ).join('');

                groupBDiv.innerHTML = displayedGroupB.map(item =>
                    `<div class="kanji-item">
                        <ruby>
                            <rb>${item.kanji}</rb>
                            <rt style="font-size: 0.6em;">${item.reading}</rt>
                        </ruby>
                    </div>`
                ).join('');
            } else {
                groupADiv.innerHTML = displayedGroupA.map(item =>
                    `<div class="kanji-item">
                        <span class="kanji-item-left">${item.kanji}</span>
                    </div>`
                ).join('');

                groupBDiv.innerHTML = displayedGroupB.map(item =>
                    `<div class="kanji-item">
                        <span class="kanji-item-left">${item.kanji}</span>
                    </div>`
                ).join('');
            }

            document.getElementById('groupsDisplay').classList.remove('hidden');
        }

        function displayQuestion() {
            const qBox = document.getElementById('questionKanji');
            if (showFurigana) {
                qBox.innerHTML = `<ruby>${currentQuestion.kanji}<rt style="font-size: 0.5em;">${currentQuestion.reading}</rt></ruby>`;
            } else {
                qBox.textContent = currentQuestion.kanji;
            }

            document.getElementById('questionBox').classList.remove('hidden');
            document.getElementById('resultBox').classList.add('hidden');

            // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            questionStartTime = performance.now();
            currentSessionData.startTime = questionStartTime;
        }

        function checkAnswer(selectedGroup) {
            const answerTime = performance.now();
            const responseTimeMs = answerTime - questionStartTime;
            const isCorrect = selectedGroup === currentQuestion.correctGroup;

            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
            currentSessionData.selectedGroup = selectedGroup;
            currentSessionData.isCorrect = isCorrect;
            currentSessionData.answerTime = answerTime;
            currentSessionData.responseTimeMs = responseTimeMs;
            currentSessionData.userGroup = userGroup;
            currentSessionData.showFurigana = showFurigana;

            // æš«å®šçš„ã«ä¿å­˜ï¼ˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒãªã„å ´åˆç”¨ï¼‰
            saveSessionData();

            const resultBox = document.getElementById('resultBox');
            const resultIcon = document.getElementById('resultIcon');
            const resultText = document.getElementById('resultText');
            const explanation = document.getElementById('explanation');

            resultBox.classList.remove('correct', 'incorrect');
            resultText.classList.remove('correct', 'incorrect');

            if (isCorrect) {
                sessionCorrectCount++;
                resultBox.classList.add('correct');
                resultText.classList.add('correct');
                resultIcon.textContent = 'ğŸ‰';
                resultText.textContent = 'æ­£è§£ï¼';
            } else {
                resultBox.classList.add('incorrect');
                resultText.classList.add('incorrect');
                resultIcon.textContent = 'âŒ';
                resultText.textContent = 'ä¸æ­£è§£';
            }

            const criteriaName = criteriaNames[currentCriteria];
            const currentKeywords = keywords[currentCriteria];
            const matchedKeywords = currentKeywords.filter(kw => currentQuestion.reading.includes(kw));

            // Wikidataãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            const createWikiLink = (item) => {
                if (item.link) {
                    return `<a href="${item.link}" target="_blank" style="color: #2196F3; text-decoration: none; font-size: 0.7em; margin-left: 4px;" title="Wikidataã§è©³ç´°ã‚’è¦‹ã‚‹">ğŸ”—</a>`;
                }
                return '';
            };

            let explanationText = `<strong>å•ã‚ã‚Œã¦ã„ã‚‹å˜èªï¼š</strong><span class="highlight">ã€Œ${currentQuestion.kanji}ã€</span>${createWikiLink(currentQuestion)}ã¯ã€<span class="highlight">ã€Œ${currentQuestion.reading}ã€</span>ã¨èª­ã¿ã¾ã™ã€‚<br><br>`;

            // ã‚°ãƒ«ãƒ¼ãƒ—Aã®åˆ†æ
            explanationText += `<strong>ã‚°ãƒ«ãƒ¼ãƒ—Aã‚’ã‚ˆãè¦‹ã‚‹ã¨</strong>èª­ã¿æ–¹ã®ä¸­ã«<strong>${criteriaName}</strong>ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚<ul>`;
            displayedGroupA.forEach(item => {
                const matched = currentKeywords.filter(kw => item.reading.includes(kw));
                explanationText += `<li><strong>${item.kanji}</strong>${createWikiLink(item)}ï¼š${item.reading}`;
                if (matched.length > 0) {
                    explanationText += `ï¼ˆ${matched.join('ã€')}ï¼‰`;
                }
                explanationText += `</li>`;
            });
            explanationText += `</ul>`;

            // ã‚°ãƒ«ãƒ¼ãƒ—Bã®åˆ†æ
            explanationText += `<strong>ä¸€æ–¹ã§ã€ã‚°ãƒ«ãƒ¼ãƒ—Bã«ã¯</strong>èª­ã¿æ–¹ã®ä¸­ã«<strong>${criteriaName}</strong>ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br><br>`;

            // çµè«–
            if (currentQuestion.correctGroup === 'A') {
                explanationText += `<strong>å•ã‚ã‚Œã¦ã„ã‚‹å˜èªã€Œ${currentQuestion.kanji}ã€${createWikiLink(currentQuestion)}ã¯ã€ã€Œ${currentQuestion.reading}ã€ã¨èª­ã¿ã€ã€Œ${matchedKeywords.join('ã€')}ã€ã¨ã„ã†${criteriaName}ã‚’å«ã‚€ãŸã‚ã€<span class="highlight">ã€Œã‚°ãƒ«ãƒ¼ãƒ—Aã€</span>ãŒæ­£è§£ã«ãªã‚Šã¾ã™ã€‚</strong>`;
            } else {
                explanationText += `<strong>å•ã‚ã‚Œã¦ã„ã‚‹å˜èªã€Œ${currentQuestion.kanji}ã€${createWikiLink(currentQuestion)}ã¯ã€ã€Œ${currentQuestion.reading}ã€ã¨èª­ã¿ã€${criteriaName}ã‚’å«ã¾ãªã„ãŸã‚ã€<span class="highlight">ã€Œã‚°ãƒ«ãƒ¼ãƒ—Bã€</span>ãŒæ­£è§£ã«ãªã‚Šã¾ã™ã€‚</strong>`;
            }

            explanation.innerHTML = explanationText;

            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³ã¨ä¿®æ­£ç‚¹å…¥åŠ›æ¬„ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.feedback-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('correctionText').value = '';
            currentCorrection = '';

            document.getElementById('questionBox').classList.add('hidden');
            resultBox.classList.remove('hidden');
        }

        function initGame() {
            document.getElementById('loading').classList.add('hidden');
            document.querySelector('.container').classList.remove('hidden');
            document.getElementById('progressContainer').classList.remove('hidden');
            generateQuestion();
        }

        // Modified startGame
        function startGame(withFurigana) {
            const datasetSelect = document.getElementById('datasetSelect');
            const selectedDataset = datasetSelect.value;

            let filename = '';
            switch (selectedDataset) {
                case '1000': filename = 'é–²è¦§æ•°1000ä»¶ä»¥ä¸Š_ä»®åãƒªã‚¹ãƒˆ.csv'; break;
                case '1500': filename = 'é–²è¦§æ•°1500ä»¶ä»¥ä¸Š_æ¼¢å­—ãƒªã‚¹ãƒˆ.csv'; break;
                case '2000': filename = 'é–²è¦§æ•°2000ä»¶ä»¥ä¸Š_æ¼¢å­—ãƒªã‚¹ãƒˆ.csv'; break;
                case '2500': filename = 'é–²è¦§æ•°2500ä»¶ä»¥ä¸Š_æ¼¢å­—ãƒªã‚¹ãƒˆ.csv'; break;
                case '3000': filename = 'é–²è¦§æ•°3000ä»¶ä»¥ä¸Š_æ¼¢å­—ãƒªã‚¹ãƒˆ.csv'; break;
                default: filename = 'é–²è¦§æ•°1000ä»¶ä»¥ä¸Š_ä»®åãƒªã‚¹ãƒˆ.csv';
            }

            showFurigana = withFurigana;
            userGroup = showFurigana ? 'A' : 'B';
            localStorage.setItem('userGroup', userGroup);

            questionCount = 0;
            sessionCorrectCount = 0;

            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameEndScreen').classList.add('hidden');

            // Show loading
            document.getElementById('loading').classList.remove('hidden');

            // Load data
            loadData(filename);
        }

        function restartGame() {
            document.getElementById('gameEndScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            // User can select dataset again
        }


        // ====== è©•ä¾¡æ©Ÿèƒ½:ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ»çµ±è¨ˆ ======
        function submitFeedback(type) {
            currentSessionData.feedbackType = type;

            // ä¿®æ­£ç‚¹ã‚’å–å¾—ã—ã¦ä¿å­˜
            const correctionText = document.getElementById('correctionText').value.trim();
            currentSessionData.correction = correctionText;
            currentCorrection = correctionText;

            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            document.querySelectorAll('.feedback-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelector(`.feedback-btn.${type}`).classList.add('selected');

            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãä¿å­˜
            const evalData = JSON.parse(localStorage.getItem('evaluationData') || '{"sessions":[]}');
            // æœ€æ–°ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            evalData.sessions[evalData.sessions.length - 1] = currentSessionData;
            localStorage.setItem('evaluationData', JSON.stringify(evalData));
        }

        function showStats() {
            const evalData = JSON.parse(localStorage.getItem('evaluationData') || '{"sessions":[]}');
            const sessions = evalData.sessions;
            const total = sessions.length;

            if (total === 0) {
                // alert('ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å•é¡Œã‚’è§£ã„ã¦ãã ã•ã„ã€‚');
                // ãƒ‡ãƒ¼ã‚¿ãŒãªãã¦ã‚‚è¡¨ç¤ºã™ã‚‹
            }

            const correctCount = sessions.filter(s => s.isCorrect).length;
            const correctRate = Math.round((correctCount / total) * 100);

            const totalTime = sessions.reduce((sum, s) => sum + (s.responseTimeMs || 0), 0);
            const avgTime = (totalTime / total / 1000).toFixed(2);

            const enlightenmentCount = sessions.filter(s => s.feedbackType === 'enlightenment').length;
            const enlightenmentRate = Math.round((enlightenmentCount / total) * 100);

            // åŸºæœ¬çµ±è¨ˆã®è¡¨ç¤º
            document.getElementById('totalQuestions').textContent = total;
            document.getElementById('correctRate').textContent = correctRate + '%';
            document.getElementById('avgTime').textContent = avgTime + 's';
            document.getElementById('enlightenmentRate').textContent = enlightenmentRate + '%';

            // UXåˆ†æ
            const flashVsKnowledge = `
                <div class="stat-card">
                    <p>è¬è§£ãç‡: ${enlightenmentRate}%</p>
                    <p>çŸ¥è­˜å•é¡Œç‡: ${Math.round((sessions.filter(s => s.feedbackType === 'knowledge').length / total) * 100)}%</p>
                </div>
            `;
            document.getElementById('uxAnalysis').innerHTML = flashVsKnowledge;

            // A/Bãƒ†ã‚¹ãƒˆçµæœ
            const groupA = sessions.filter(s => s.userGroup === 'A' || (s.showFurigana));
            const groupB = sessions.filter(s => s.userGroup === 'B' || (!s.showFurigana));

            const getGroupStats = (groupSessions) => {
                if (groupSessions.length === 0) return { count: 0, correctRate: 0, avgTime: 0 };
                const cor = groupSessions.filter(s => s.isCorrect).length;
                const time = groupSessions.reduce((sum, s) => sum + (s.responseTimeMs || 0), 0);
                return {
                    count: groupSessions.length,
                    correctRate: Math.round((cor / groupSessions.length) * 100),
                    avgTime: (time / groupSessions.length / 1000).toFixed(2)
                };
            };

            const statsA = getGroupStats(groupA);
            const statsB = getGroupStats(groupB);

            const abTable = `
                <table class="ab-test-table">
                    <tr>
                        <th>ã‚°ãƒ«ãƒ¼ãƒ—</th>
                        <th>æ¡ä»¶</th>
                        <th>å•é¡Œæ•°</th>
                        <th>æ­£è§£ç‡</th>
                        <th>å¹³å‡è§£ç­”æ™‚é–“</th>
                    </tr>
                    <tr>
                        <td>A</td>
                        <td>ãµã‚ŠãŒãªã‚ã‚Š</td>
                        <td>${statsA.count}</td>
                        <td>${statsA.correctRate}%</td>
                        <td>${statsA.avgTime}s</td>
                    </tr>
                    <tr>
                        <td>B</td>
                        <td>ãµã‚ŠãŒãªãªã—</td>
                        <td>${statsB.count}</td>
                        <td>${statsB.correctRate}%</td>
                        <td>${statsB.avgTime}s</td>
                    </tr>
                </table>
            `;
            document.getElementById('abTestResults').innerHTML = abTable;

            // é¡ä¼¼æ€§ã‚¹ã‚³ã‚¢åˆ†æ
            const highSim = sessions.filter(s => s.similarityScore >= 5);
            const lowSim = sessions.filter(s => s.similarityScore < 5);

            const simAnalysis = `
                <p>é¡ä¼¼æ€§ãŒé«˜ã„å•é¡Œï¼ˆã‚¹ã‚³ã‚¢5ä»¥ä¸Šï¼‰ã®æ­£è§£ç‡: ${getGroupStats(highSim).correctRate}%</p>
                <p>é¡ä¼¼æ€§ãŒä½ã„å•é¡Œï¼ˆã‚¹ã‚³ã‚¢5æœªæº€ï¼‰ã®æ­£è§£ç‡: ${getGroupStats(lowSim).correctRate}%</p>
            `;
            document.getElementById('similarityAnalysis').innerHTML = simAnalysis;

            // ã‚·ã‚¹ãƒ†ãƒ åŠ¹ç‡æ€§
            const avgGenTime = sessions.reduce((sum, s) => sum + (s.generationTimeMs || 0), 0) / (total || 1);
            const humanTime = 15 * 60; // 15åˆ† = 900ç§’
            const sysTimeSec = avgGenTime / 1000;
            const reduction = ((humanTime - sysTimeSec) / humanTime * 100).toFixed(4);

            const effAnalysis = `
                <p>ã‚·ã‚¹ãƒ†ãƒ å¹³å‡ç”Ÿæˆæ™‚é–“: ${avgGenTime.toFixed(2)}ms</p>
                <p>äººé–“ï¼ˆæƒ³å®š15åˆ†ï¼‰ã¨ã®æ¯”è¼ƒ: <strong>${reduction}%</strong> ã®æ™‚é–“å‰Šæ¸›</p>
            `;
            document.getElementById('efficiencyAnalysis').innerHTML = effAnalysis;

            document.getElementById('statsModal').style.display = 'block';
        }

        function closeStats() {
            document.getElementById('statsModal').style.display = 'none';
        }

        function downloadCSV() {
            const evalData = JSON.parse(localStorage.getItem('evaluationData') || '{"sessions":[]}');
            const sessions = evalData.sessions;

            if (sessions.length === 0) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // CSVãƒ˜ãƒƒãƒ€ãƒ¼(æ—¥æœ¬èªã§åˆ†ã‹ã‚Šã‚„ã™ã)
            const headers = [
                'ã‚»ãƒƒã‚·ãƒ§ãƒ³ID',
                'æ—¥æ™‚',
                'ãƒ†ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ—',
                'ãµã‚ŠãŒãªè¡¨ç¤º',
                'åˆ†é¡åŸºæº–',
                'å•é¡Œã®æ¼¢å­—',
                'å•é¡Œã®èª­ã¿',
                'æ­£è§£ã‚°ãƒ«ãƒ¼ãƒ—',
                'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”',
                'æ­£èª¤',
                'è§£ç­”æ™‚é–“(ç§’)',
                'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯',
                'ä¿®æ­£ç‚¹',
                'é¡ä¼¼æ€§ã‚¹ã‚³ã‚¢',
                'å•é¡Œç”Ÿæˆæ™‚é–“(ãƒŸãƒªç§’)'
            ];

            // CSVãƒ‡ãƒ¼ã‚¿ä½œæˆ(æ—¥æœ¬èªã§åˆ†ã‹ã‚Šã‚„ã™ã)
            const csvContent = [
                headers.join(','),
                ...sessions.map(s => {
                    const feedbackLabel = s.feedbackType === 'enlightenment' ? 'ã‚¹ãƒƒã‚­ãƒªã—ãŸ' :
                        s.feedbackType === 'knowledge' ? 'ã‚¹ãƒƒã‚­ãƒªã—ãªã‹ã£ãŸ' : 'æœªå›ç­”';
                    const correctLabel = s.isCorrect ? 'æ­£è§£' : 'ä¸æ­£è§£';
                    const furiganaLabel = s.showFurigana ? 'ã‚ã‚Š' : 'ãªã—';
                    const criteriaLabel = criteriaNames[s.criteria] || s.criteria;
                    const responseTimeSec = s.responseTimeMs ? (s.responseTimeMs / 1000).toFixed(2) : '';
                    const correctionText = (s.correction || '').replace(/,/g, 'ã€').replace(/\n/g, ' ');

                    return [
                        s.sessionId,
                        new Date(s.timestamp).toLocaleString('ja-JP'),
                        s.userGroup || (s.showFurigana ? 'A' : 'B'),
                        furiganaLabel,
                        criteriaLabel,
                        s.questionKanji,
                        s.questionReading || '',
                        `ã‚°ãƒ«ãƒ¼ãƒ—${s.correctGroup}`,
                        s.selectedGroup ? `ã‚°ãƒ«ãƒ¼ãƒ—${s.selectedGroup}` : '',
                        correctLabel,
                        responseTimeSec,
                        feedbackLabel,
                        `"${correctionText}"`,
                        s.similarityScore || '',
                        s.generationTimeMs ? s.generationTimeMs.toFixed(2) : ''
                    ].join(',');
                })
            ].join('\n');

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ä½œæˆ
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'riddle_evaluation_data.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function nextQuestion() {
            // ä¿®æ­£ç‚¹ã‚’ä¿å­˜ã—ã¦ã‹ã‚‰æ¬¡ã®å•é¡Œã¸
            const correctionText = document.getElementById('correctionText').value.trim();
            if (correctionText && currentSessionData) {
                currentSessionData.correction = correctionText;
                const evalData = JSON.parse(localStorage.getItem('evaluationData') || '{"sessions":[]}');
                evalData.sessions[evalData.sessions.length - 1] = currentSessionData;
                localStorage.setItem('evaluationData', JSON.stringify(evalData));
            }

            if (questionCount >= MAX_QUESTIONS) {
                endGame();
            } else {
                generateQuestion();
            }
        }

        window.onload = function () {
            // document.querySelector('.container').classList.add('hidden'); // Already hidden by CSS or default? No, container is not hidden by default in CSS, but check body structure.
            // In original HTML, container has no hidden class initially, but startScreen does.
            // We want startScreen visible, container hidden initially.

            document.querySelector('.container').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');

            initEvaluationSystem();
            // loadAllFiles(); // Don't load yet

            // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            window.onclick = function (event) {
                const modal = document.getElementById('statsModal');
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        };
    </script>
</body>

</html>
