<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êº¢Â≠óË™≠„ÅøÂàÜÈ°û„ÇØ„Ç§„Ç∫</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to bottom right, #e8f5e9, #e3f2fd);
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; font-size: 2em; }
        .loading { text-align: center; padding: 40px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4CAF50; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error { background: #ffebee; color: #c62828; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #c62828; }
        .groups-display { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .group-box { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .group-header { padding: 15px; color: white; font-size: 1.2em; font-weight: bold; text-align: center; }
        .group-header.green { background: #4CAF50; }
        .group-header.blue { background: #2196F3; }
        .group-content { padding: 20px; min-height: 180px; }
        .kanji-item { padding: 12px 15px; margin-bottom: 10px; background: #f5f5f5; border-radius: 8px; text-align: center; }
        .kanji-item-left { font-size: 1.5em; font-weight: bold; }
        .question-box { background: white; border-radius: 10px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .question-text { font-size: 1.3em; color: #333; margin-bottom: 20px; }
        .question-kanji { font-size: 4em; font-weight: bold; color: #FF5722; margin: 30px 0; }
        .answer-buttons { display: flex; gap: 20px; justify-content: center; margin-top: 30px; }
        .answer-btn { padding: 20px 60px; font-size: 1.5em; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s; }
        .answer-btn.green { background: #4CAF50; color: white; }
        .answer-btn.blue { background: #2196F3; color: white; }
        .answer-btn:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .result-box { background: white; border-radius: 10px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .result-box.correct { border: 4px solid #4CAF50; }
        .result-box.incorrect { border: 4px solid #f44336; }
        .result-icon { font-size: 5em; margin-bottom: 20px; }
        .result-text { font-size: 1.5em; font-weight: bold; margin-bottom: 20px; }
        .result-text.correct { color: #4CAF50; }
        .result-text.incorrect { color: #f44336; }
        .explanation { font-size: 1.1em; color: #555; margin: 20px 0; padding: 25px; background: #f5f5f5; border-radius: 8px; text-align: left; line-height: 1.8; }
        .next-btn { padding: 15px 40px; font-size: 1.2em; font-weight: bold; background: #FF9800; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="container">
    <h1>Êº¢Â≠óË™≠„ÅøÂàÜÈ°û„ÇØ„Ç§„Ç∫</h1>

    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p>„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...</p>
    </div>

    <div id="error" class="error hidden"></div>

    <div id="groupsDisplay" class="groups-display hidden">
        <div class="group-box">
            <div class="group-header green">„Ç∞„É´„Éº„ÉóA</div>
            <div class="group-content" id="groupADisplay"></div>
        </div>
        <div class="group-box">
            <div class="group-header blue">„Ç∞„É´„Éº„ÉóB</div>
            <div class="group-content" id="groupBDisplay"></div>
        </div>
    </div>

    <div id="questionBox" class="question-box hidden">
        <div class="question-text">„Åì„ÅÆÊº¢Â≠ó„ÅØ„Ç∞„É´„Éº„ÉóA„Å®„Ç∞„É´„Éº„ÉóB„ÅÆ„Å©„Å°„Çâ„Åß„Åó„Çá„ÅÜ„ÅãÔºü</div>
        <div class="question-kanji" id="questionKanji"></div>
        <div class="answer-buttons">
            <button class="answer-btn green" onclick="checkAnswer('A')">„Ç∞„É´„Éº„ÉóA</button>
            <button class="answer-btn blue" onclick="checkAnswer('B')">„Ç∞„É´„Éº„ÉóB</button>
        </div>
    </div>

    <div id="resultBox" class="result-box hidden">
        <div class="result-icon" id="resultIcon"></div>
        <div class="result-text" id="resultText"></div>
        <div class="explanation" id="explanation"></div>
        <button class="next-btn" onclick="nextQuestion()">Ê¨°„ÅÆÂïèÈ°å„Å∏</button>
    </div>
</div>

<script>
let allData = [];
let currentCriteria = null;
let groupAData = [];
let groupBData = [];
let currentQuestion = null;
let displayedGroupA = [];
let displayedGroupB = [];

// È°û‰ººÂ∫¶„Çπ„Ç≥„Ç¢Èñ¢Êï∞
// „ÄêÂ§âÊõ¥„ÄëË™≠„Åø„ÅÆÂÖ±ÈÄöÊñáÂ≠ó √ó Ë™≠„Åø„ÅÆÈï∑„Åï„ÅÆËøë„Åï„Çí„Çπ„Ç≥„Ç¢Âåñ
function similarity(a, b) {
    let score = 0;

    // ÂÖ±ÈÄöÊñáÂ≠ó„Çí„Ç´„Ç¶„É≥„Éà
    for (const ch of a.reading) {
        if (b.reading.includes(ch)) score += 2;
    }

    // Ë™≠„Åø„ÅÆÈï∑„ÅïÂ∑Æ„ÅåÂ∞è„Åï„ÅÑ„Åª„Å©È´ò„Çπ„Ç≥„Ç¢
    score += Math.max(0, 5 - Math.abs(a.reading.length - b.reading.length));

    return score;
}

const criteriaNames = {
    nature: 'Ëá™ÁÑ∂',
    color: 'Ëâ≤',
    animal: 'ÂãïÁâ©',
    body: '‰Ωì'
};

async function loadFile(filename) {
    const response = await fetch(filename);
    const text = await response.text();
    return text;
}

async function loadAllFiles() {
    const files = ['Ëá™ÁÑ∂.txt', 'Ëâ≤.txt', 'Ë∫´‰Ωì.txt', 'ÂãïÁâ©.txt'];

    for (const file of files) {
        const content = await loadFile(file);
        const lines = content.split('\n').filter(line => line.trim() && !line.startsWith('Êº¢Â≠ó'));

        lines.forEach(line => {
            const [kanji, reading] = line.split(',');
            if (kanji && reading) {
                allData.push({ kanji: kanji.trim(), reading: reading.trim() });
            }
        });
    }

    document.getElementById('loading').classList.add('hidden');
    generateQuestion();
}

// ÂàÜÈ°ûÂü∫Ê∫ñ ‚Üí ÁèæÂú®„ÅØ„Éï„Ç°„Ç§„É´Âçò‰Ωç„ÅßÂàÜÈ°û
function classifyData() {
    const criteriaFileMap = {
        nature: 'Ëá™ÁÑ∂',
        color: 'Ëâ≤',
        animal: 'ÂãïÁâ©',
        body: 'Ë∫´‰Ωì'
    };

    const targetFile = criteriaFileMap[currentCriteria];

    groupAData = allData.filter(x => x.source === targetFile);
    groupBData = allData.filter(x => x.source !== targetFile);
}

// 2„Å§„ÅÆ„Ç∞„É´„Éº„Éó„Åã„ÇâÈ°û‰ººÂ∫¶È†Ü„ÅßÊäΩÂá∫
function pickTopSimilar(base, list, count) {
    return [...list]
        .filter(x => x.kanji !== base.kanji)
        .map(x => ({ ...x, sim: similarity(base, x) }))
        .sort((a, b) => b.sim - a.sim)
        .slice(0, count);
}

function generateQuestion() {

    const extra = allData.map(x => x);

    const criteriaKeys = ['nature', 'color', 'animal', 'body'];
    currentCriteria = criteriaKeys[Math.floor(Math.random() * criteriaKeys.length)];

    // „Ç∞„É´„Éº„ÉóA/B „ÇíÂàÜÈ°ûÔºà„Éï„Ç°„Ç§„É´Âçò‰ΩçÔºâ
    const natureList = allData.filter(x => x.file === 'Ëá™ÁÑ∂');
    const colorList = allData.filter(x => x.file === 'Ëâ≤');
    const animalList = allData.filter(x => x.file === 'ÂãïÁâ©');
    const bodyList = allData.filter(x => x.file === 'Ë∫´‰Ωì');

    const map = { nature: natureList, color: colorList, animal: animalList, body: bodyList };

    groupAData = map[currentCriteria];
    groupBData = extra.filter(x => !groupAData.includes(x));

    // Âá∫È°åÊº¢Â≠ó„ÇíÊ±∫ÂÆö
    const useA = Math.random() < 0.5;

    if (useA) {
        currentQuestion = groupAData[Math.floor(Math.random() * groupAData.length)];
        currentQuestion.correctGroup = 'A';

        displayedGroupA = pickTopSimilar(currentQuestion, groupAData, 4);
        displayedGroupB = pickTopSimilar(currentQuestion, groupBData, 4);

    } else {
        currentQuestion = groupBData[Math.floor(Math.random() * groupBData.length)];
        currentQuestion.correctGroup = 'B';

        displayedGroupA = pickTopSimilar(currentQuestion, groupAData, 4);
        displayedGroupB = pickTopSimilar(currentQuestion, groupBData, 4);
    }

    displayGroups();
    displayQuestion();
}

function displayGroups() {
    document.getElementById("groupADisplay").innerHTML =
        displayedGroupA.map(item => `<div class="kanji-item"><span class="kanji-item-left">${item.kanji}</span></div>`).join('');

    document.getElementById("groupBDisplay").innerHTML =
        displayedGroupB.map(item => `<div class="kanji-item"><span class="kanji-item-left">${item.kanji}</span></div>`).join('');

    document.getElementById("groupsDisplay").classList.remove("hidden");
}

function displayQuestion() {
    document.getElementById("questionKanji").textContent = currentQuestion.kanji;

    document.getElementById("questionBox").classList.remove("hidden");
    document.getElementById("resultBox").classList.add("hidden");
}

function checkAnswer(selected) {
    const correct = selected === currentQuestion.correctGroup;

    const box = document.getElementById("resultBox");
    const icon = document.getElementById("resultIcon");
    const text = document.getElementById("resultText");

    box.classList.remove("correct", "incorrect");

    if (correct) {
        box.classList.add("correct");
        icon.textContent = "üéâ";
        text.textContent = "Ê≠£Ëß£ÔºÅ";
    } else {
        box.classList.add("incorrect");
        icon.textContent = "‚ùå";
        text.textContent = "‰∏çÊ≠£Ëß£ÔºÅ";
    }

    document.getElementById("questionBox").classList.add("hidden");
    box.classList.remove("hidden");
}

function nextQuestion() {
    generateQuestion();
}

window.onload = loadAllFiles;
</script>

</body>
</html>
